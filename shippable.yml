language: python

python:
   - "2.7"
#   - "3.3"
#   - "pypy"

addons:
   firefox: "21.0"

services:
  - mongodb
  - mysql

# secure variables BINTRAYAPI, YAFRAFTPPWD
env:
  global:
    - YAFRABUILD=$BUILD_NUMBER
    # YAFRAFTPPWD
    - secure: LCgvX4xQozqZ9TPyslOorNMpNhoK5L+y00QDmIjBH5bdRG/WtB7v5MwFRx9WqXzaqubXNa18gRnyjH9vzLsH2KIf+onWFjA3vejehnQwfxRoxzK2Kxdv4pprIiTvni7JqNQlz7vU6Z1O3RVsFe4ugUVX91kp28DJ/uv6Q9bkl76IPbqe1uh1v6sNiT80T+oRZtkzNB/5Zf3ku+TLiVo4rH/2UNXp74Dw2rqcxhwG4/tAodX262TGh2/z52uRrK2corBURZZMJNPxMi4ryxTKhdP0JkyiVtM6nP9kUFUiVBZnDxr9yqpxjhPT/FfuC492Ndx2XmocozR+fBdWIBxZ6Q==
    # BINTRAYAPI
    - secure: kxwRfTVK/aync2C/obu9sN1NA6tvVJdSzqyT/pcfj/S9oZ0Y2nEOPK5ZsMk/3JGfHZ4baeAyUBjInZXhWqn8ERe8FByMZDnKohoe112+EwB0D2B3IkKt+IiiBzHrCz2eL4I37cfL6pPTpzHdoo5mnCAJf1ji3NLxy7VuBapu27gn7hRVg9yiQ6Gtht3yzzj7rl9mZNKJbOmX84wFewP11MCY7Bbzjh7OFJSUFxIOlPa2mvCtXlKFTN/6v5rgvVN91cpyDsj7NaFrZPe/AnsPkn8QJCZZUdO4Qsv67upeH4yn1xGsR4GPzDLjk8BjEV123RLDAJ3UuszzVTkE5JsAiw==

install:
  - pwd
  - cd backend
  - pip install -r requirements.txt --use-mirrors
  - cd ../www
  - npm -q install
  - bower --quiet install
  - cd ..

before_script:
  - pwd
  - mkdir -p shippable/testresults
  - mkdir -p shippable/codecoverage
  - mkdir -p shippable/screenshots
  - export DISPLAY=:99.0
  - sh -e /etc/init.d/xvfb start
  - www/node_modules/.bin/http-server -p 8081 www/app/ &
  - sleep 1

script:
  - pwd
  - cd www
  - node_modules/.bin/gulp karma
  - node_modules/.bin/gulp protractor
  - node_modules/.bin/gulp jshint
  - node_modules/.bin/gulp changelog
  - node_modules/.bin/istanbul report cobertura --dir ../shippable/codecoverage/
  - cd ../backend
  - export PYTHONPATH=$PYTHONPATH:.
  #- nosetests tests/TestDatabase.py --with-xunit --xunit-file=../shippable/testresults/nosetests.xml
  - nosetests tests/TestDatabase.py --with-xunit --xunit-file=../shippable/testresults/nosetests.xml --with-coverage --cover-xml-file=../shippable/codecoverage/py-coverage.xml --cover-xml
  - cd ..
  #- sudo ./build-shippable.sh

after_success:
  - pwd
  - cd ..
  - echo $BUILD_NUMBER
  - sudo tar cvf yapki-build.tar yapki/
  - sudo gzip yapki-build.tar
  - sudo -E cp yapki-build.tar.gz yapki-build-$BUILD_NUMBER.tar.gz
  - sudo curl -T yapki-build-$BUILD_NUMBER.tar.gz -u yafraorg:$BINTRAYAPI https://api.bintray.com/content/yafraorg/yafra-distribution/yapki/v1.0/
  - sudo curl -T yapki-build.tar.gz -u yafrarel@yafra.org:$YAFRAFTPPWD ftp://ftp.yafra.org/
